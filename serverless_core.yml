package:
  patterns:
    - '!*.spec.js'
    - '!*.yml'
    - '!serverless.yml'
  individually: true
params:
  default:
    AWS_ACCOUNT_ID: ${env:AWS_ACCOUNT_ID, '1111'}
    API_KEY: ${env:API_KEY, 'API_KEY_HERE'}
    DB_URI: ${env:DB_URI, 'mongodb://localhost:27017/${ENV:PROJECT_SLUG}'}
    EVENT_BUS_ARN: ${env:EVENT_BUS_ARN, 'EVENT_BUS_ARN_HERE'}
    GIT_SHA: ${env:GIT_SHA , ''}
    GIT_BRANCH: ${env:GIT_BRANCH, ''}
    DEPLOY_TIME: ${env:DEPLOY_TIME, ''}
    LOG_LEVEL: ${env:LOG_LEVEL, 'info'}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY, 'OPENAI_API_KEY_HERE'}

provider:
  name: aws
  runtime: nodejs14.x
  endpointType: regional
  region: ${env:AWS_REGION, 'us-east-1'}
  memorySize: 512 # Overwrite the default memory size. Default is 1024..
  versionFunctions: false # Stops saving a complete version of each function each time its deployed
  iam:
    role: arn:aws:iam::${param:AWS_ACCOUNT_ID}:role/sls-execution-role
  deploymentBucket:
    name: ${env:PROJECT_SLUG}-${sls:stage} # Deployment bucket name. Default is generated by the framework
    maxPreviousDeploymentArtifacts: 2 # On every deployment the framework prunes the bucket to remove artifacts older than this limit. The default is 5
    blockPublicAccess: true
  apiGateway:
    disableDefaultEndpoint: true
    restApiId: REST_API_ID_HERE
    restApiRootResourceId: REST_API_ROOT_RESOURCE_ID_HERE
  logRetentionInDays: 14
  vpc:
    securityGroupIds:
      - DEFAULT_SECURITY_GROUP_ID_HERE
    subnetIds:
      - DEFAULT_SUBNET_ID_HERE
      - DEFAULT_SUBNET_ID_HERE
      - DEFAULT_SUBNET_ID_HERE
  tags:
    version: ${param:GIT_SHA}
    branch: ${param:GIT_BRANCH}
    deploy_time: ${param:DEPLOY_TIME}
    stage: ${sls:stage}
    service: ${env:PROJECT_SLUG}-${sls:stage}-${self:service}
    'git.commit.sha': ${param:GIT_SHA}
    'git.repository_url': https://github.com/jrmeier/flex-framework

plugins:
  - serverless-bundle
  - serverless-add-api-key
custom:
  bundle:
    status: true
    linting: false
    minifyOptions:
      keepNames: true
    sourceMaps: true
    caching: true
    excludeFiles: ['**/*.spec.js', '**/mock*.js']
    disableForkTsChecker: true
    esbuild: true
    externals:
      - mongoose
      - graphql-compose-mongoose
      - graphql-compose
      - graphql
  apiKeys:
    - name: ${PROJECT_SLUG}-api-key
      value: ${param:API_KEY}
  offline:
    allowCache: true # Important: This will prevent serverless-offline from eating all of your memory
